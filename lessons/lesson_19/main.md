# Миграция схем: alembic

**_Версионирование таблиц_** - это процесс управления изменениями в схеме базы данных путем создания и применения миграций. 
Миграции - это файлы, которые описывают изменения в структуре базы данных, такие как добавление, изменение или удаление таблиц, столбцов, индексов и т. д.

**_Alembic_** - это инструмент для управления миграциями баз данных в Python. 
Позволяет разработчикам определять миграции в виде кода Python и применять их к базе данных. 
Например, если вы хотите добавить новое поле в таблицу или изменить тип данных столбца, вы создаете миграцию, описывающую это изменение, а затем применяете ее к вашей базе данных.

_https://alembic.sqlalchemy.org/en/latest/tutorial.html_

`create_all()` - используется только для отладки. В реальных проектах - не используем  

`poetry add alembic`  
`alembic init alembic`
После инициализации получим файлы alembic  
`mako` - формат шаблонов  
`env.py` - файл для миграций  

_Существует режим выполнения миграций - online/offline_
```python
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

**_offline_** - режим предполагает, что база данных находится в оффлайн-режиме, то есть не доступна для подключений из внешних источников.  
В этом случае миграции выполняются без непосредственного доступа к базе данных, например, путем генерации SQL-скриптов, которые будут выполнены позднее, когда база данных снова будет доступна.  

**_online_** - режим предполагает, что база данных доступна для выполнения миграций напрямую, без необходимости генерации SQL-скриптов.   
В этом режиме миграции могут применяться к базе данных непосредственно с использованием инструментов миграции, таких как Alembic, который может взаимодействовать с базой данных напрямую и автоматически применять изменения.

_Пример изменения env.py с собственным параметром DB_URL конфига_ 
`config.set_main_option("sqlalchemy.url", DB_URL)`  

`alembic history` - показать историю ревизий БД
`alembic current `- подключение к БД (согласно конфигу, указанному в env.py)  

Каждая ревизия представляет собой отдельную миграцию, которая описывает изменения в схеме базы данных, такие как создание, изменение или удаление таблиц, столбцов, индексов и т. д.  
**_Создание ревизий_**  
`alembic revision -m "create accounts table"`  


_В env.py нужно указать откуда брать информацию о созданных таблицах_
```python
from models import Base

# add your model's MetaData object here
target_metadata = Base.metadata
```

`alembic revision --autogenerate` - сгенерировать новую ревизию (миграцию)  
`alembic revision --autogenerate -m "new migration"` - сгенерировать с сообщением  

`alembic upgrade head` - применить миграцию и перейти на 1 уровень дальше  
`alembic downgrade -1` - откатиться на 1 уровень  

